name: Docker Image CI

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master", "develop" ]

jobs:

  build:
    runs-on: ubuntu-latest
    
    steps:
        - name: 'Checkout GitHub Action'
          uses: actions/checkout@main
          
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v2
          
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2
          
        - name: Login to Docker Hub
          uses: docker/login-action@v2
          with:
              registry: ghcr.io
              username: ${{github.actor}}
              password: ${{secrets.GHCR_TOKEN}}
              
        - name: Get current date to use it as TAG
          run: | 
            echo "date +%d%m%Y%H%M " >> $GITHUB_OUTPUT
          id: curr_date
          
        - name: Build and push
          uses: docker/build-push-action@v4
          with:
            platforms: linux/amd64,linux/arm64
            push: true
            tags: |
              ghcr.io/szymonrysztof/python-monitoring-agent:latest
              ghcr.io/szymonrysztof/python-monitoring-agent:${{ steps.curr_date.outputs }}
            
